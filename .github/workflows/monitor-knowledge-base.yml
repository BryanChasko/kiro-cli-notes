name: Monitor Knowledge Base Health

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Validate Knowledge Base
      run: |
        echo "üîç [TRACE] Started: health_check"
        
        # Check if knowledge.json exists
        if [ ! -f "knowledge-base/static-site/knowledge.json" ]; then
          echo "‚ùå [EVENT] health_check: missing_knowledge_file"
          exit 1
        fi
        
        # Validate JSON structure
        if ! jq empty knowledge-base/static-site/knowledge.json; then
          echo "‚ùå [EVENT] health_check: invalid_json"
          exit 1
        fi
        
        # Check chunk count
        CHUNK_COUNT=$(jq '.metadata.totalChunks' knowledge-base/static-site/knowledge.json)
        echo "üìä [EVENT] health_check: chunk_count_validated (chunks: $CHUNK_COUNT)"
        
        if [ "$CHUNK_COUNT" -lt 40 ]; then
          echo "‚ö†Ô∏è [EVENT] health_check: low_chunk_count (chunks: $CHUNK_COUNT)"
        fi
        
        # Check last update time
        EXPORT_DATE=$(jq -r '.metadata.exportDate' knowledge-base/static-site/knowledge.json)
        echo "üìä [EVENT] health_check: last_export_date ($EXPORT_DATE)"
        
        echo "‚úÖ [TRACE] health_check: success"
        
    - name: Test Static Site
      run: |
        echo "üîç [TRACE] Started: static_site_test"
        cd knowledge-base/static-site
        
        # Check required files
        for file in index.html js/app.js js/search.js js/indexeddb.js css/styles.css; do
          if [ ! -f "$file" ]; then
            echo "‚ùå [EVENT] static_site_test: missing_file ($file)"
            exit 1
          fi
        done
        
        echo "‚úÖ [TRACE] static_site_test: success"
